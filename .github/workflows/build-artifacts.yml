name: Build Artifacts

on:
  workflow_dispatch:
    inputs:
      build_macos:
        description: 'Build macOS app'
        required: false
        default: true
        type: boolean
      build_android:
        description: 'Build Android APK'
        required: false
        default: true
        type: boolean

jobs:
  build-macos:
    if: ${{ inputs.build_macos }}
    runs-on: macos-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: aarch64-apple-darwin
        
    - name: Cache Cargo dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        
    - name: Build Rust FFI library
      run: |
        cargo build -p openclipboard_ffi --release

    - name: Generate bindings (Swift + Kotlin) and sync into macOS package
      run: |
        export OPENCLIPBOARD_BINDINGS_PROFILE=release
        ./ffi/scripts/generate_bindings.sh
        ./macos/sync_bindings.sh
        ls -la macos/OpenClipboardBindings/
        
    - name: Setup Swift
      uses: swift-actions/setup-swift@v2
      
    - name: Build + test macOS Swift package
      run: |
        cd macos
        export OPENCLIPBOARD_FFI_LIB_DIR="../target/release"
        export DYLD_LIBRARY_PATH="$PWD/../target/release"
        swift test
        swift build -c release
        
    - name: Create app bundle structure
      run: |
        cd macos
        mkdir -p OpenClipboard.app/Contents/{MacOS,Frameworks,Resources}
        
        # Copy executable
        cp .build/release/OpenClipboard OpenClipboard.app/Contents/MacOS/
        
        # Copy FFI library
        cp ../target/release/libopenclipboard_ffi.dylib OpenClipboard.app/Contents/Frameworks/
        
        # Create minimal Info.plist
        cat > OpenClipboard.app/Contents/Info.plist << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>CFBundleDisplayName</key>
            <string>OpenClipboard</string>
            <key>CFBundleExecutable</key>
            <string>OpenClipboard</string>
            <key>CFBundleIdentifier</key>
            <string>com.openclipboard.macos</string>
            <key>CFBundleInfoDictionaryVersion</key>
            <string>6.0</string>
            <key>CFBundleName</key>
            <string>OpenClipboard</string>
            <key>CFBundlePackageType</key>
            <string>APPL</string>
            <key>CFBundleShortVersionString</key>
            <string>1.0.0</string>
            <key>CFBundleVersion</key>
            <string>1</string>
            <key>LSMinimumSystemVersion</key>
            <string>13.0</string>
            <key>LSUIElement</key>
            <true/>
        </dict>
        </plist>
        EOF
        
    - name: Package app as ZIP
      run: |
        cd macos
        zip -r OpenClipboard-macos.zip OpenClipboard.app
        
    - name: Upload macOS app artifact
      uses: actions/upload-artifact@v4
      with:
        name: OpenClipboard-macOS
        path: macos/OpenClipboard-macos.zip

  build-android:
    if: ${{ inputs.build_android }}
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Java 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: Setup Android NDK
      run: |
        echo "y" | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --install "ndk;26.1.10909125"
        echo "ANDROID_NDK_ROOT=$ANDROID_SDK_ROOT/ndk/26.1.10909125" >> $GITHUB_ENV
        
    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: aarch64-linux-android,armv7-linux-androideabi,x86_64-linux-android
        
    - name: Cache Cargo dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        
    - name: Install cargo-ndk
      run: cargo install cargo-ndk
      
    - name: Cross-compile Rust FFI for Android
      run: |
        export NDK_HOME=$ANDROID_NDK_ROOT
        cargo ndk -t arm64-v8a -t armeabi-v7a -t x86_64 -o android/app/src/main/jniLibs build -p openclipboard_ffi --release
        
    - name: Generate Kotlin bindings (for Android build)
      run: |
        export OPENCLIPBOARD_BINDINGS_PROFILE=debug
        ./ffi/scripts/generate_bindings.sh
        
    - name: Cache Gradle dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        
    - name: Make gradlew executable
      run: chmod +x android/gradlew
      
    - name: Run Android JVM unit tests
      run: |
        # Ensure host Rust cdylib exists for unit tests
        cargo build -p openclipboard_ffi
        cd android
        ./gradlew testDebugUnitTest --no-daemon

    - name: Build Android APK
      run: |
        cd android
        ./gradlew assembleDebug --no-daemon

    - name: List produced APKs
      run: |
        ls -Rlah android/app/build/outputs || true

    - name: Upload Android APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: OpenClipboard-Android
        # Be resilient to variant/filename differences across AGP versions.
        path: android/app/build/outputs/**/*.apk
        if-no-files-found: error

  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable
      
    - name: Cache Cargo dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-test-${{ hashFiles('**/Cargo.lock') }}
        
    - name: Run Rust tests
      run: cargo test --quiet
      
    - name: Verify FFI builds
      run: cargo build -p openclipboard_ffi